---
export const prerender = true;
import BookLayout from "../layouts/BookLayout.astro";
import FishSheet from "../components/FishSheet.astro";
import FloatingAddButton from "../components/FloatingAddButton.astro";
import AddFishModal from "../components/AddFishModal.astro";
import { supabase } from "../lib/supabase";
import FishIndex from "../components/FishIndex.astro";


const { data } = await supabase
  .from("fish_records")
  .select("*")
  .order("created_at", { ascending: true });

const fishes = data ?? [];



const pageIndex = 0; // √≠ndice siempre
const fish = fishes[pageIndex] || null;
const safeIndex = 0;
const BASE = import.meta.env.BASE_URL;


let tankName = null;

if (fish) {
  type TankJoin = {
	tank: {
		name: string;
	} | null;
	};

	const { data: tankData, error } = await supabase
	.from('tank_fish')
	.select('tank:tank_id(name)')
	.eq('fish_id', fish.id)
	.limit(1);

	const typedTankData = tankData as TankJoin[] | null;

	tankName = typedTankData?.[0]?.tank?.name ?? null;


}



// Exponer las vars PUBLIC_ en el HTML para que el script cliente las lea
const PUBLIC_SUPABASE_URL = import.meta.env.PUBLIC_SUPABASE_URL;
const PUBLIC_SUPABASE_ANON_KEY = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
const PUBLIC_SUPABASE_BUCKET = import.meta.env.PUBLIC_SUPABASE_BUCKET ?? "";
---


<body data-max-pages={fishes.length - 1}>

<BookLayout title="Mi Libro de Acuarios">

	<div slot="left">
		{pageIndex === 0 ? (
			<FishIndex fishes={fishes} />
		) : (
			fish && (
			<FishSheet
				id={fish.id}
				foto_url={fish.foto_url}
				nombre_comun={fish.nombre_comun}
				nombre_cientifico={fish.nombre_cientifico}
				familia={fish.familia}
				origen={fish.origen}
				color={fish.color}
				sexo={fish.sexo}
				tamano={fish.tamano_adulto}
				temperatura_min={fish.temperature_min}
				temperatura_max={fish.temperature_max}
				ph_minimo={fish.ph_min}
				ph_maximo={fish.ph_max}
				gh_minimo={fish.gh_min}
				gh_maximo={fish.gh_max}
				kh_minimo={fish.kh_min}
				kh_maximo={fish.kh_max}
				comportamiento={fish.comportamiento}
				alimentacion={fish.alimentacion}
				compatibilidad={fish.compatibilidad}
				reproduccion={fish.reproduccion}
				fecha_incorporacion={fish.fecha_incorporacion}
				acuario={tankName}
				fecha_fallecimiento={fish.fecha_fallecimiento}
				causa_muerte={fish.causa_muerte}
				compradoEn={fish.comprado_en}
				curiosidades={fish.curiosidades}
				notas={fish.notas_adicionales}
			/>
			)
		)}
	</div>

	

	<div slot="right" class="image-page">
		{pageIndex === 0 ? (
			<div class="index-cover">
			<h2>√çndice general</h2>
			<p>Seleccione una especie</p>
			</div>
		) : (
			fish && (
			fish.foto_url ? (
				<img src={fish.foto_url} alt={fish.nombre_comun} loading="lazy" />
			) : (
				<div class="no-image">
				<p class="no-image-title">{fish.nombre_comun}</p>
				<button id="add-photo-btn" class="add-photo-btn">A√±adir foto</button>
				</div>
			)
			)
		)}
	</div>

	
	<!-- Navegaci√≥n 
	<nav slot="nav" class="book-nav">
		{fishes.length > 0 && (
			<a class="next" href={`${BASE}page/1/`} data-astro-reload>
			Empezar ‚Üí
			</a>
		)}
	</nav>-->
	<nav slot="nav" class="book-nav">
        {fishes.length > 0 && (
			<a class="next" href={`${BASE}page/1/`} data-astro-reload>
			Siguienta ‚Üí
			</a>
		)}
    </nav>


	<!-- UI flotante + modal + scripts -->
	<div slot="ui">

		<FloatingAddButton />
		<AddFishModal />
		<div
			id="page-data"
			data-fishes={JSON.stringify(fishes)}
			data-index={safeIndex}>
		</div>
		<div
			id="supabase-config"
			style="display:none"
			data-url={PUBLIC_SUPABASE_URL}
			data-key={PUBLIC_SUPABASE_ANON_KEY}
			data-bucket={PUBLIC_SUPABASE_BUCKET}>
		</div>
		
		<script type="module">
			import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
			const pageData = document.getElementById("page-data");
			const fishes = JSON.parse(pageData.dataset.fishes);
			let currentIndex = Number(pageData.dataset.index);

			//mapear campos del formulario a campos de la tabla
			//cada clave debe coincidir con data-field en FishSheet y name en el formulario
			//queda la estructura as√≠: data-field: "name"
			const FIELD_MAP = {
				foto_url: "fotoUrl",
				nombre_comun: "nombreComun",
				nombre_cientifico: "nombreCientifico",
				familia: "familia",
				origen: "origen",
				color: "color",
				sexo: "sexo",
				tamano_adulto: "tamanoAdulto",
				temperature_min: "temperaturaMin",
				temperature_max: "temperaturaMax",
				ph_min: "phMin",
				ph_max: "phMax",
				gh_min: "ghMin",
				gh_max: "ghMax",
				kh_min: "khMin",
				kh_max: "khMax",
				comportamiento: "comportamiento",
				alimentacion: "alimentacion",
				compatibilidad: "compatibilidad",
				reproduccion: "reproduccion",
				fecha_incorporacion: "fechaIncorporacion",
				acuario: "tank_id",
				fecha_fallecimiento: "fechaFallecimiento",
				causa_muerte: "causaMuerte",
				comprado_en: "compradoEn",
				curiosidades: "curiosidades",
				notas_adicionales: "notas"
			};


			// Exponer configuraci√≥n Supabase desde el DOM
			const cfgEl = document.getElementById("supabase-config");
			const supabaseUrl = cfgEl?.dataset?.url;
			const supabaseAnonKey = cfgEl?.dataset?.key;
			const supabaseBucket = cfgEl?.dataset?.bucket || '';
			if (!supabaseUrl || !supabaseAnonKey) console.warn("Supabase public config missing in DOM");
			const supabaseClient = createClient(supabaseUrl || "", supabaseAnonKey || "");

			const initModal = () => {
				console.debug("[modal] initModal");
				const backdrop = document.getElementById("modal-backdrop");
				if (!backdrop) return;

				const form = document.getElementById("add-fish-form") ?? backdrop.querySelector("form");
				const addBtn = document.getElementById("add-page-btn");
				const cancelBtn = document.getElementById("cancel-btn");
				const fabToggle = document.getElementById('fabToggle');
				const waterLevelsBtn = document.getElementById('waterLevels');
				const originalTankId = form.dataset.originalTankId || null;

				
				const openModal = () => {
					// If form is in photo-only mode, disable the rest of fields to avoid validation errors
					if (form && form.dataset.photoOnly === '1') {
						setPhotoOnlyMode(true);
					}
					backdrop.hidden = false;
					backdrop.style.display = "flex";
					backdrop.setAttribute("aria-hidden", "false");
					// Attach fresh file-upload handler when modal opens
					setupFileUpload();
					loadTankSelect();
				};
				const closeModal = () => {
					backdrop.hidden = true;
					backdrop.style.display = "none";
					backdrop.setAttribute("aria-hidden", "true");
					if (form) {
						form.dataset.mode = "create";
						form.dataset.fishId = "";
						delete form.dataset.photoOnly;
						delete form.dataset.original;
						const title = document.getElementById("modal-title");
						if (title) title.textContent = "Nueva ficha de pez";
						form.reset();
						// re-enable all fields when closing
						setPhotoOnlyMode(false);
					}

					// Ensure add-photo button is wired if present
					setupAddPhotoBtn();
					// Setup file upload handling for the modal
					setupFileUpload();
				};

				// asegurar estado inicial
				backdrop.hidden = true;
				backdrop.style.display = "none";
				backdrop.setAttribute("aria-hidden", "true");

				// listeners directos
				if (addBtn) addBtn.addEventListener("click", (ev) => { ev.stopPropagation(); openModal(); });
				// Toggle floating actions
				if (fabToggle) fabToggle.addEventListener('click', (ev) => { ev.stopPropagation(); const fab = fabToggle.closest('.fab'); if (fab) fab.classList.toggle('open'); });
				if (cancelBtn) cancelBtn.addEventListener("click", (ev) => { ev.preventDefault(); ev.stopPropagation(); closeModal(); });
				if (waterLevelsBtn) waterLevelsBtn.addEventListener('click', (ev) => { ev.stopPropagation(); window.location.href = '/libro_acuarios/water-levels'; });
				
				// Helper to attach click handler to the "A√±adir foto" button in the image page
				const setupAddPhotoBtn = () => {
					const btn = document.getElementById("add-photo-btn");
					if (!btn || btn.dataset.listenerAttached) return;
					btn.addEventListener("click", (ev) => {
						ev.preventDefault(); ev.stopPropagation();
						if (!form) return;
						const sheet = document.querySelector('.fish-sheet');
						if (!sheet) return;
						const fishId = sheet.dataset.fishId;
						if (!fishId) return;
						form.dataset.mode = 'edit';
						// Open modal in photo-only mode
						form.dataset.photoOnly = '1';
						// Store original foto_url for diff logic
						const fotoElOrig = sheet.querySelector('.value[data-field="foto_url"]');
						const origVal = fotoElOrig ? (fotoElOrig.textContent || '').trim() : '';
						form.dataset.original = JSON.stringify({ foto_url: origVal === '‚Äî' ? null : origVal || null });
						form.dataset.fishId = fishId;
						const title = document.getElementById('modal-title');
						if (title) title.textContent = 'A√±adir foto';
						// Prefill fotoUrl if present in hidden field
						const fotoEl = sheet.querySelector('.value[data-field="foto_url"]');
						const fotoInput = form.elements['fotoUrl'];
						const current = fotoEl ? (fotoEl.textContent || '').trim() : '';
						if (fotoInput) fotoInput.value = (current === '‚Äî' ? '' : current) || '';
						openModal();
					});
					btn.dataset.listenerAttached = '1';
				};

				// Setup upload for the fotoFile input: upload via server endpoint and fill fotoUrl
				const setupFileUpload = () => {
					if (!form) return;
					const fileInput = form.elements['fotoFile'];
					const fotoInput = form.elements['fotoUrl'];
					const statusEl = form.querySelector('.upload-status');
					if (!fileInput) return;
					fileInput.onchange = async () => {
						const f = fileInput.files ? fileInput.files[0] : null;
						if (!f) return;
						if (statusEl) statusEl.textContent = 'Subiendo...';
						try {
							const fd = new FormData();
							

							fd.append('file', f);
							if (supabaseBucket) fd.append('bucket', supabaseBucket);
							const res = await fetch('/api/upload-photo', { method: 'POST', body: fd });
							if (!res.ok) {
								const txt = await res.text();
								console.error('upload-photo failed', res.status, txt);
								if (statusEl) statusEl.textContent = 'Error al subir: ' + (txt || res.statusText);
								return;
							}
							let json;
							try { json = await res.json(); } catch (e) { json = null; }
							if (json && json.publicUrl) {
								if (statusEl) statusEl.textContent = 'Subida completada';
								if (fotoInput) fotoInput.value = json.publicUrl;
							} else {
								if (statusEl) statusEl.textContent = 'Subida completada, pero no se obtuvo URL p√∫blica.';
							}
						} catch (err) {
							if (statusEl) statusEl.textContent = 'Error: ' + (err?.message || err);
						}
					};
				};

				// =========================
				// üê† Cargar acuarios en el select
				// =========================
				const loadTankSelect = async () => {
				if (!form) return;
				const select = form.elements['tank_id'];
				if (!select) return;

				// evitar duplicados si se abre varias veces
				if (select.dataset.loaded === '1') return;

				const { data, error } = await supabaseClient
					.from('tanks')
					.select('id, name')
					.order('created_at');

				if (error) {
					console.error('Error cargando acuarios', error);
					return;
				}

				data.forEach(tank => {
					const opt = document.createElement('option');
					opt.value = tank.id;
					opt.textContent = tank.name;
					select.appendChild(opt);
				});

				select.dataset.loaded = '1';
				};


				// Enable/disable full fields when photo-only mode is active
				const setPhotoOnlyMode = (enable) => {
					if (!form) return;
					const container = form.querySelector('.full-fields');
					if (!container) return;
					const controls = container.querySelectorAll('input, textarea, select, button');
					controls.forEach((el) => {
						if (enable) {
							el.setAttribute('disabled', '');
						} else {
							el.removeAttribute('disabled');
						}
					});
				};

				// Delegaci√≥n: navegaci√≥n, edici√≥n y cierre por backdrop
				document.addEventListener("click", async (ev) => {
					const target = ev.target;
					if (!(target instanceof Element)) return;

					// Prev/Next links ‚Äî fuerza navegaci√≥n completa
					const addPhotoBtn = target.closest("#add-photo-btn");
					if (addPhotoBtn instanceof HTMLButtonElement) {
						ev.preventDefault(); ev.stopPropagation();
						if (!form) return;
						const sheet = document.querySelector('.fish-sheet');
						if (!sheet) return;
						const fishId = sheet.dataset.fishId;
						if (!fishId) return;
						form.dataset.mode = 'edit';
						// photo-only mode
						form.dataset.photoOnly = '1';
						const fotoElOrig = sheet.querySelector('.value[data-field="foto_url"]');
						const origVal = fotoElOrig ? (fotoElOrig.textContent || '').trim() : '';
						form.dataset.original = JSON.stringify({ foto_url: origVal === '‚Äî' ? null : origVal || null });
						form.dataset.fishId = fishId;
						const title = document.getElementById('modal-title');
						if (title) title.textContent = 'A√±adir foto';
						const fotoEl = sheet.querySelector('.value[data-field="foto_url"]');
						const fotoInput = form.elements['fotoUrl'];
						const current = fotoEl ? (fotoEl.textContent || '').trim() : '';
						if (fotoInput) fotoInput.value = (current === '‚Äî' ? '' : current) || '';
						openModal();
						return;
					}
					
					const nav = target.closest("a.prev, a.next");
					if (nav instanceof HTMLAnchorElement) {
						ev.preventDefault();
						ev.stopPropagation();

						const book = document.querySelector(".book");
						const pages = document.querySelectorAll(".page");
						
						document.querySelector(".next")?.addEventListener("click", (e) => {
							e.preventDefault();

							const book = document.querySelector(".book");
							const right = document.querySelector(".page.right");

							sessionStorage.setItem("pageTurn", "next");

							right.classList.add("turn-pre-next");

							// Esperamos a que llegue al centro
							setTimeout(() => {
								window.location.href = e.currentTarget.href;
							}, 450);
						});


						document.querySelector(".prev")?.addEventListener("click", () => {
							book.dataset.direction = "prev";
						});

						pages.forEach(p => {
							p.classList.remove("turn-next", "turn-prev");
							p.classList.add(nav.classList.contains("next") ? "turn-next" : "turn-prev");
						});

						setTimeout(() => {
							window.location.assign(nav.href);
						}, 350);

						return;
					}

					// Editar ficha (si hacemos click dentro de .fish-sheet)
					if (!target.closest("#add-page-btn")) {
						const sheet = target.closest(".fish-sheet");
						if (sheet && form) {
							const fishId = sheet.dataset.fishId;
							if (!fishId) return;

							form.dataset.mode = "edit";
							// Ensure full edit (not photo-only)
							delete form.dataset.photoOnly;
							form.dataset.fishId = fishId;

							const title = document.getElementById("modal-title");
							if (title) title.textContent = "Editar ficha";

							const original = {};

							const fields = sheet.querySelectorAll(".value[data-field]");
							fields.forEach((el) => {
								const dbKey = el.dataset.field;
								const value = el.textContent.trim();

								// 1Ô∏è‚É£ Guardar valor original (para diff)
								original[dbKey] = value === "‚Äî" ? null : value;

								// 2Ô∏è‚É£ Rellenar input correspondiente
								const formKey = FIELD_MAP[dbKey];
								if (!formKey) return;

								const input = form.elements[formKey];
								if (input) {
								input.value = value === "‚Äî" ? "" : value;
								}
								if (dbKey === "acuario") {
									// special case: tank_id select
									const select = form.elements['tank_id'];
									if (select) {
										select.value = value || "";
									}
								}
								
							});

							form.dataset.original = JSON.stringify(original);

							// =========================
							// üê† Cargar acuario actual del pez
							// =========================
							const tankSelect = form.elements['tank_id'];
							if (tankSelect) {
								const { data, error } = await supabaseClient
									.from('tank_fish')
									.select('tank_id')
									.eq('fish_id', fishId)
									.limit(1);

								if (error) {
								console.error('Error cargando acuario del pez', error);
								}

								tankSelect.value = data?.[0]?.tank_id ?? '';


							}

							openModal();
							return;
						}

					}

					// Cerrar al clicar el fondo
					if (target === backdrop) { closeModal(); return; }
				});

				// Escape
				document.addEventListener("keydown", (e) => { if (e.key === "Escape" && !backdrop.hidden) closeModal(); });

				// Submit
				if (form) {
					form.addEventListener("submit", async (ev) => {
					ev.preventDefault();

					const fd = new FormData(form);
					const tankId = fd.get('tank_id');
					const fishId = form.dataset.fishId;
					let payload = {};
					const selectedTankId = form.querySelector('[name="tank_id"]')?.value || null;
					const tankChanged = selectedTankId !== originalTankId;
					
					// validar min < max
					const pairs = [
						["temperatura_min", "temperatura_max", "Temperatura"],
						["ph_min", "ph_max", "pH"],
						["gh_min", "gh_max", "GH"],
						["kh_min", "kh_max", "KH"],
						];

						for (const [minKey, maxKey, label] of pairs) {
						const min = fd.get(minKey);
						const max = fd.get(maxKey);

						if (min && max && Number(min) > Number(max)) {
							alert(`${label}: el valor m√≠nimo no puede ser mayor que el m√°ximo`);
							return;
						}
					}


					// =========================
					// ‚úèÔ∏è EDITAR
					// =========================
					if (form.dataset.mode === "edit") {
						const original = JSON.parse(form.dataset.original || "{}");

						for (const [dbKey, oldValue] of Object.entries(original)) {
							const formKey = FIELD_MAP[dbKey];
							if (!formKey) continue;

							const rawNew = fd.get(formKey);
							const newValue =
								rawNew === "" || rawNew == null ? null : rawNew.trim();
							const oldNormalized =
								oldValue === "" || oldValue == null ? null : oldValue.trim();

							if (newValue !== oldNormalized) {
								// Ensure foto_url never becomes null (DB enforces NOT NULL)
								if (dbKey === "foto_url" && (newValue === null || newValue === "")) {
									payload[dbKey] = "";
								} else {
									payload[dbKey] = newValue;
								}
							}
						}

						console.debug("[modal] cleanPayload (edit)", payload);

						const hasFishChanges = Object.keys(payload).length > 0;
						const hasTankChange = !!tankId;

						if (!hasFishChanges && !hasTankChange) {
							console.debug("[modal] no changes detected");
							closeModal();
							return;
						}

						// Actualizar DOM
						const sheet = document.querySelector(
							`.fish-sheet[data-fish-id="${form.dataset.fishId}"]`
						);

						if (sheet) {
							Object.entries(payload).forEach(([dbKey, value]) => {
								const el = sheet.querySelector(`.value[data-field="${dbKey}"]`);
								if (el) el.textContent = value ?? "‚Äî";
							});

							// Si se actualiz√≥ la foto, actualizar tambi√©n la vista derecha
							const imagePage = document.querySelector('.image-page');
							if (imagePage && Object.prototype.hasOwnProperty.call(payload, 'foto_url')) {
								const newUrl = payload.foto_url || '';
								if (newUrl) {
									imagePage.innerHTML = `<img src="${newUrl}" alt="${sheet.querySelector('.value[data-field="nombre_comun"]')?.textContent || ''}" loading="lazy" />`;
								} else {
									imagePage.innerHTML = `<div class="no-image"><p class="no-image-title">${sheet.querySelector('.value[data-field="nombre_comun"]')?.textContent || ''}</p><button id="add-photo-btn" class="add-photo-btn">A√±adir foto</button></div>`;
								}
								// Re-attach handler to the newly inserted button
								setupAddPhotoBtn();
							}
							
						}
						// =========================
						// üê† Actualizar acuario (edit)
						/// =========================
						// Guardar cambios del pez (si los hay)
						if (hasFishChanges) {
							const res = await supabaseClient
								.from("fish_records")
								.update(payload)
								.eq("id", fishId);

							if (res.error) {
								alert(res.error.message);
								return;
							}
						}

						// Guardar / actualizar acuario (independiente)
						if (tankChanged && selectedTankId) {
							const { error } = await supabaseClient
								.from('tank_fish')
								.upsert(
								{
									fish_id: fishId,
									tank_id: selectedTankId,
									quantity: 1
								},
								{ onConflict: 'fish_id' }
								);

							if (error) {
								console.error('[tank_fish]', error);
								alert('Error al asignar el pez al acuario');
								return;
							}
							window.location.reload();
						}
					}

					// =========================
					// ‚ûï CREAR (con reutilizaci√≥n de especie)
					// =========================
					else {
						for (const [dbKey, formKey] of Object.entries(FIELD_MAP)) {
							const raw = fd.get(formKey);
							payload[dbKey] = raw === "" || raw == null ? null : raw.trim();	
						}

						if (payload.foto_url == null) payload.foto_url = "";

						const scientificName = payload.nombre_cientifico?.trim();
						let speciesId = null;

						if (scientificName) {
							const { data: existingSpecies } = await supabaseClient
							.from("fish_species")
							.select("id")
							.eq("scientific_name", scientificName)
							.maybeSingle();

							speciesId = existingSpecies?.id;

							if (!speciesId) {
							const { data: newSpecies, error: speciesError } =
								await supabaseClient
								.from("fish_species")
								.insert({
									scientific_name: scientificName,
									common_name: payload.nombre_comun,
									temperature_min: payload.temperature_min,
									temperature_max: payload.temperature_max,
									ph_min: payload.ph_min,
									ph_max: payload.ph_max,
									gh_min: payload.gh_min,
									gh_max: payload.gh_max,
									kh_min: payload.kh_min,
									kh_max: payload.kh_max,
									size_cm: payload.tamano_adulto
								})
								.select()
								.single();

							if (speciesError) {
								alert("Error creando especie: " + speciesError.message);
								return;
							}

							speciesId = newSpecies.id;
						}
					}

					payload.species_id = speciesId;

					const res = await supabaseClient
						.from("fish_records")
						.insert([payload])
						.select()
						.single();

					if (res.error) {
						alert(res.error.message);
						return;
					}

					const tankId = fd.get("tank_id");

					if (tankId) {
						await supabaseClient.from("tank_fish").insert({
						tank_id: tankId,
						fish_id: res.data.id,
						quantity: 1
						});
					}

					window.location.reload();
					}


					closeModal();
					form.reset();
					});


				}
			};

			if (document.readyState === "loading") {
				document.addEventListener("DOMContentLoaded", initModal);
			} else {
				initModal();
			}

			// Navegaci√≥n por teclado entre p√°ginas (global)
			document.addEventListener("keydown", (e) => {
				if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) return;

				const match = window.location.pathname.match(/\/page\/(\d+)/);
				const current = match ? Number(match[1]) : 0;
				const max = Number(document.body.dataset.maxPages ?? 0);

				if (e.key === "ArrowRight" && current < max) {
					window.location.href = `${import.meta.env.BASE_URL}page/${current + 1}/`;
				}

				if (e.key === "ArrowLeft") {
					if (current === 1) {
					window.location.href = import.meta.env.BASE_URL;
					} else if (current > 1) {
					window.location.href = `${import.meta.env.BASE_URL}page/${current - 1}/`;
					}
				}
			});


			

			const book = document.querySelector(".book");
			const sheet = document.querySelector(".fish-sheet");
			const image = document.querySelector(".image-page img");

			const renderFish = (fish) => {
				// TEXTO
				sheet.querySelector("[data-field='familia']").textContent = fish.familia ?? "‚Äî";
				sheet.querySelector("[data-field='origen']").textContent = fish.origen ?? "‚Äî";
				sheet.querySelector("[data-field='comportamiento']").textContent = fish.comportamiento ?? "‚Äî";
				// ‚Ä¶ (igual para el resto)

				// IMAGEN
				image.src = fish.foto_url;
				image.alt = fish.nombre_comun;
			};
			const next = () => {
				if (currentIndex >= fishes.length - 1) return;

				const right = document.querySelector(".page.right");
				right.classList.add("turn-next");

				setTimeout(() => {
					currentIndex++;
					renderFish(fishes[currentIndex]);
					right.classList.remove("turn-next");
				}, 700);
				};

				const prev = () => {
				if (currentIndex <= 0) return;

				const left = document.querySelector(".page.left");
				left.classList.add("turn-prev");

				setTimeout(() => {
					currentIndex--;
					renderFish(fishes[currentIndex]);
					left.classList.remove("turn-prev");
				}, 700);
			};
			document.querySelector(".next")?.addEventListener("click", (e) => {
				e.preventDefault();
				next();
			});

			document.querySelector(".prev")?.addEventListener("click", (e) => {
				e.preventDefault();
				prev();
			});
			
			window.addEventListener("DOMContentLoaded", () => {
				const action = sessionStorage.getItem("pageTurn");
				if (!action) return;

				sessionStorage.removeItem("pageTurn");

				const left = document.querySelector(".page.left");
				const right = document.querySelector(".page.right");

				if (action === "next") {
					left.classList.add("turn-post-next");
				}

				if (action === "prev") {
					right.classList.add("turn-post-prev");
				}
			});
			

			// Single delegated handler for FAB interactions (toggle, waterLevels, add-page)
			const fab = document.querySelector('.fab');
			document.addEventListener("click", async (ev) => {
				// Normalize to an Element in case the click target is a text node (emoji)
				let node = ev.target;
				while (node && node.nodeType !== 1) {
					node = node.parentNode;
				}
				if (!node) return;
				const el = /** @type {Element} */ (node);

				// Toggle FAB
				if (el.closest('#fabToggle')) {
					ev.preventDefault();
					ev.stopPropagation();
					if (fab) fab.classList.toggle('open');
					return;
				}

				// Water levels action
				if (el.closest('#waterLevels')) {
					ev.preventDefault();
					ev.stopPropagation();
					if (fab) fab.classList.remove('open');
					window.location.href = `${import.meta.env.BASE_URL}water-levels/`;
					return;
				}

				// Add page action ‚Äî delegate to existing handler by clicking the button programmatically
				if (el.closest('#add-page-btn')) {
					ev.preventDefault();
					ev.stopPropagation();
					if (fab) fab.classList.remove('open');
					const addBtn = document.getElementById('add-page-btn');
					if (addBtn) addBtn.click();
					return;
				}

				// Close FAB when clicking outside
				if (fab && !fab.contains(el)) {
					fab.classList.remove('open');
				}
			});
		</script>

		<style>
		.image-page { display: flex; align-items: center; justify-content: center; min-height: 320px; }
		.image-page img { max-width: 100%; max-height: 80vh; object-fit: contain; }
		.image-page .no-image { display:flex; flex-direction:column; align-items:center; gap:1rem; color:#333; padding:1rem; }
		.image-page .no-image-title { font-size:1.1rem; font-weight:600; }
		.add-photo-btn { background:#2b7a78; color:#fff; border:none; padding:0.6rem 1rem; border-radius:6px; cursor:pointer; }
		.add-photo-btn:hover { opacity:0.95 }
		</style>
	</div>
</BookLayout>





